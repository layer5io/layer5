name: Label Triggered Workflow
on: 
  watch:
    types: [started]

  issues:
    types:
      - labeled

  pull_request_target:
    types:
      - labeled

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  comment:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
        with:
          ref: master
      - name: Label Commenter
        uses: peaceiris/actions-label-commenter@v1

  automate_invite:
    if: contains(github.event.issue.labels.*.name, 'issue/invite')
    runs-on: ubuntu-latest
    steps:
      - name: Invite on label
        uses: vj-abigo/invite-on-label@v1.2
        with:
          organization: layer5io
          label: issue/invite
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          comment: "We are sending you an invitation to join the Layer5 GitHub Organization. :partying_face: <b>Welcome to the community! üéâ</b><br /><br />&nbsp;&nbsp;&nbsp;Be sure to :star: [star the projects](../stargazers), if you haven't already.<br />"
        env:
          INVITE_TOKEN: ${{ secrets.RELEASEDRAFTER_PAT }}
      - name: View context attributes
        uses: actions/github-script@master
        id: set-url
        with:
          script: |
            const url = context.issue.url
            return url
          result-encoding: string
      - name: Get url
        run: |
          echo "URL=${{steps.set-url.outputs.result}}" >> $GITHUB_ENV
          echo "ISSUE=${{steps.set-url.outputs.url}}" >> $GITHUB_ENV
      - name: Notify slack
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        uses: pullreminders/slack-action@master
        with:
          args: '{\"channel\":\"CF9RK4H89\",\"text\":\"An invitation to join the layer5io GitHub org has been sent\"}'
          # to the author of: ${{env.URL}}\"}'

  star-notify:
    if: github.event_name == 'watch'
    name: Notify Slack on star
    runs-on: ubuntu-latest
    steps:
    - name: Get current star count
      run: |
        echo "STARS=$(curl --silent 'https://api.github.com/repos/${{github.repository}}' -H 'Accept: application/vnd.github.preview' | jq '.stargazers_count')" >> $GITHUB_ENV
    - name: Notify slack
      env:
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      uses: pullreminders/slack-action@master
      with:
        args: '{\"channel\":\"CSK7N9TGX\",\"text\":\"${{ github.actor }} just starred ${{github.repository}}! (https://github.com/${{github.repository}}/stargazers) Total ‚≠êÔ∏è: ${{env.STARS}}\"}'
  
  good-first-issue-notify:
    if:  github.event_name == 'issues' && github.event.label.name == 'good first issue' || github.event.label.name == 'first-timers-only' 
    name: Notify Slack for new good-first-issue
    runs-on: ubuntu-latest
    steps:
      - name: Notify slack
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        uses: pullreminders/slack-action@master
        with:
          args: |
            {
            "channel": "C019426UBNY",
            "text": "A new, good first issue is up for grabs: [${{github.event.issue.title}}](${{github.event.issue.html_url}})"
            }
