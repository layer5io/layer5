"use strict";(self.webpackChunkLayer5=self.webpackChunkLayer5||[]).push([[60221],{76044:function(e,n,t){t.r(n),t.d(n,{Head:function(){return h},default:function(){return p}});t(20410);var a=t(28453),r=t(96540),s=t(94441);function l(e){const n=Object.assign({p:"p",pre:"pre",code:"code",em:"em"},(0,a.R)(),e.components);return r.createElement(s.x,null,r.createElement(n.p,null,"Service routes and version subsets should be in place given the destination rules applied in Lab 3. If they are not present, re-apply the destination rules:"),r.createElement("br"),r.createElement(n.pre,null,r.createElement(n.code,{className:"language-yaml"},"apiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: productpage\nspec:\n  host: productpage\n  subsets:\n    - name: v1\n      labels:\n        version: v1\n---\n\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\nname: reviews\nspec:\nhost: reviews\nsubsets: - name: v1\nlabels:\nversion: v1 - name: v2\nlabels:\nversion: v2 - name: v3\nlabels:\nversion: v3\n\n---\n\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\nname: ratings\nspec:\nhost: ratings\nsubsets: - name: v1\nlabels:\nversion: v1 - name: v2\nlabels:\nversion: v2 - name: v2-mysql\nlabels:\nversion: v2-mysql - name: v2-mysql-vm\nlabels:\nversion: v2-mysql-vm\n\n---\n\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\nname: details\nspec:\nhost: details\nsubsets: - name: v1\nlabels:\nversion: v1 - name: v2\nlabels:\nversion: v2\n\n---\n\n")),r.createElement("br"),r.createElement("h2",{className:"chapter-sub-heading"},r.createElement(n.p,null,"Start managing traffic routes")),r.createElement(n.p,null,"Some basics to get us started."),r.createElement("h3",{className:"chapter-sub-heading"},r.createElement(n.p,null,"Send all requests to Productpage v1")),r.createElement(n.pre,null,r.createElement(n.code,{className:"language-yaml"},"apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n    - route:\n        - destination:\n            host: reviews\n            subset: v1\n\n\n")),r.createElement(n.p,null,r.createElement(n.em,null,"Using Meshery, apply custom configuration.")),r.createElement(n.p,null,"Refresh BookInfo productpage"),r.createElement("h3",{className:"chapter-sub-heading"},r.createElement(n.p,null,"Send all requests to Productpage v2")),r.createElement(n.pre,null,r.createElement(n.code,{className:"language-yaml"},"apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n    - route:\n        - destination:\n            host: reviews\n            subset: v2\n")),r.createElement(n.p,null,r.createElement(n.em,null,"Using Meshery, apply custom configuration.")),r.createElement(n.p,null,"Refresh BookInfo productpage."),r.createElement("h2",{className:"chapter-sub-heading"},r.createElement(n.p,null,"Traffic routing based on user or user-agent type")),r.createElement("br"),r.createElement("h3",{className:"chapter-sub-heading"},r.createElement(n.p,null,"Redirect requests from mobile devices")),r.createElement(n.pre,null,r.createElement(n.code,{className:"language-yaml"},'apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: bookinfo\nspec:\n  hosts:\n    - "bookinfo.meshery.io"\n  gateways:\n    - sample-app-gateway\n  http:\n    - match:\n        - headers:\n            User-Agent:\n              regex: ^.*Mobile.*$\n      route:\n        - headers:\n            request:\n              set:\n                x-response: "Success with Mobile"\n          destination:\n            host: productpage\n            port:\n              number: 9080\n    - route:\n        - destination:\n            host: product\n            subset: random\n\n\n')),r.createElement(n.p,null,"Set your browser to mimic a mobile device. Enable Developer tools, if need. Refresh BookInfo productpage."),r.createElement("h3",{className:"chapter-sub-heading"},r.createElement(n.p,null,"Redirect requests based on HTTP header information")),r.createElement(n.p,null,"Example of using user information from HTTP headers to redirect requests."),r.createElement(n.pre,null,r.createElement(n.code,{className:"language-yaml"},"apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n    - match:\n        - headers:\n            end-user:\n              exact: naruto\n      route:\n        - destination:\n            host: reviews\n            subset: v2\n    - match:\n        - headers:\n            end-user:\n              exact: sasuke\n      route:\n        - destination:\n            host: reviews\n            subset: v3\n    - route:\n        - destination:\n            host: reviews\n            subset: v1\n\n\n")),r.createElement("h2",{className:"chapter-sub-heading"},r.createElement(n.p,null,"Traffic Mirroring with Istio")),r.createElement(n.p,null,"You will need to generate load on BookInfo's productpage service. See Lab 4 for instructions for running a performance test."),r.createElement(n.pre,null,r.createElement(n.code,{className:"language-yaml"},"apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n    - route:\n        - destination:\n            host: reviews\n            subset: v1\n          weight: 100\n      mirror:\n        host: reviews\n        subset: v2\n      mirror_percent: 100\n\n")),r.createElement(n.p,null,"Incrementally increase the traffic split percentage to the higher version service #. Start at 20% traffic split"),r.createElement(n.pre,null,r.createElement(n.code,{className:"language-yaml"},"apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n    - route:\n        - destination:\n            host: reviews\n            subset: v1\n          weight: 80\n        - destination:\n            host: reviews\n            subset: v3\n          weight: 20\n\n\n")),r.createElement(n.p,null,"Move to 50%. Observe in Meshery."),r.createElement(n.pre,null,r.createElement(n.code,{className:"language-yaml"},"apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n    - route:\n        - destination:\n            host: reviews\n            subset: v1\n          weight: 50\n        - destination:\n            host: reviews\n            subset: v3\n          weight: 50\n\n")),r.createElement("h2",{className:"chapter-sub-heading"},r.createElement(n.p,null,"Injecting Latency")),r.createElement(n.p,null,"Acknowledging the fallacy that the network is always reliable, you will intentionally cause a little chaos."),r.createElement("h3",{className:"chapter-sub-heading"},r.createElement(n.p,null,"Exploring timeouts with Reviews service")),r.createElement(n.p,null,"Note Istio Proxy's default timeout settings."),r.createElement(n.pre,null,r.createElement(n.code,{className:"language-yaml"},"\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n    - match:\n        - headers:\n            end-user:\n              exact: naruto\n      fault:\n        delay:\n          percentage:\n            value: 100.0\n          fixedDelay: 11s\n      route:\n        - destination:\n            host: reviews\n            subset: v1\n    - route:\n        - destination:\n            host: reviews\n            subset: v2\n\n")),r.createElement("h3",{className:"chapter-sub-heading"},r.createElement(n.p,null,"Exploring timeouts with Ratings service")),r.createElement(n.pre,null,r.createElement(n.code,{className:"language-yaml"},"\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: ratings\nspec:\n  hosts:\n    - ratings\n  http:\n    - match:\n        - headers:\n            end-user:\n              exact: naruto\n      fault:\n        delay:\n          percentage:\n            value: 100.0\n          fixedDelay: 5s\n      route:\n        - destination:\n            host: ratings\n            subset: v1\n    - route:\n        - destination:\n            host: ratings\n            subset: v1\n\n")),r.createElement("h2",{className:"chapter-sub-heading"},r.createElement(n.p,null,"Retries")),r.createElement(n.p,null,"Overcoming the latency issue."),r.createElement("h3",{className:"chapter-sub-heading"},r.createElement(n.p,null,"Set 5 retry attempts and a 3 second timeout")),r.createElement(n.pre,null,r.createElement(n.code,{className:"language-yaml"},"apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n    - route:\n        - destination:\n            host: reviews\n            subset: v1\n      retries:\n        attempts: 5\n        perTryTimeout: 3s\n\n")),r.createElement("br"),r.createElement(n.p,null,r.createElement("h3",null,"Alternative: Manual installation"),"\nFollow these steps if the above steps did not work"),r.createElement("br"),r.createElement("br"),r.createElement("h4",{className:"chapter-alt-heading"}," Traffic management with Istio"),r.createElement(n.p,null,"If you haven't forked or cloned this repository, please do so now:"),r.createElement(n.pre,null,r.createElement(n.code,{className:"language-sh"},"git clone https://github.com/layer5io/advanced-istio-service-mesh-workshop\n\n")),r.createElement("h4",{className:"chapter-alt-heading"}," ",r.createElement(n.p,null,"Route all traffic to version V1")),r.createElement(n.pre,null,r.createElement(n.code,{className:"language-sh"},"kubectl apply -f route-v1-v2/v1.yaml\n")),r.createElement("h4",{className:"chapter-alt-heading"}," ",r.createElement(n.p,null,"Route all traffic to version V2")),r.createElement(n.pre,null,r.createElement(n.code,{className:"language-sh"},"kubectl apply -f route-v1-v2/v2.yaml\n")),r.createElement("h3",{className:"chapter-sub-heading"},r.createElement(n.p,null,"Traffic routing based on user or user-agent type")),r.createElement("h4",{className:"chapter-alt-heading"}," Redirect requests from mobile devices"),r.createElement(n.pre,null,r.createElement(n.code,{className:"language-sh"},"kubectl apply -f route-header/device.yaml\n")),r.createElement("h4",{className:"chapter-alt-heading"}," Redirect requests based on Cookie data "),r.createElement(n.pre,null,r.createElement(n.code,{className:"language-sh"},"kubectl apply -f route-header/user.yaml\n")))}var i=function(e){void 0===e&&(e={});const{wrapper:n}=Object.assign({},(0,a.R)(),e.components);return n?r.createElement(n,e,r.createElement(l,e)):l(e)},o=t(60522),c=t(79681),m=t(63562);const u=e=>{let{data:n,location:t,children:a}=e;const s=n.TOC.nodes.sort((e,n)=>{var t,a;return(null!==(t=e.frontmatter)&&void 0!==t&&t.order?e.frontmatter.order:100)-(null!==(a=n.frontmatter)&&void 0!==a&&a.order?n.frontmatter.order:100)});return r.createElement(r.Fragment,null,r.createElement(m.Ay,null,r.createElement(c.A,{chapterData:n.chapter,TOCData:s,courseData:n.course.nodes[0],location:t,serviceMeshesList:n.TOC.nodes},a)))};function p(e){return r.createElement(u,e,r.createElement(i,e))}const h=e=>{let{data:n}=e;return r.createElement(o.A,{title:n.chapter.frontmatter.chapterTitle,canonical:"https://layer5.io/learn/learning-paths"})}}}]);