{"componentChunkName":"component---src-templates-learn-chapter-js","path":"/learn/learning-paths/mastering-service-meshes-for-developers/introduction-to-service-meshes/istio/routing-and-canary/","result":{"data":{"chapter":{"body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign ? Object.assign.bind() : function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"docType\": \"Chapter\",\n  \"chapterTitle\": \"Request Routing and Canary Testing\",\n  \"description\": \"Meshery is the cloud native management plane which offers lifecycle, configuration, and performance management of service meshes and their workloads.\",\n  \"videos\": 4,\n  \"lectures\": 12,\n  \"order\": 5\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(ChapterStyle, {\n    mdxType: \"ChapterStyle\"\n  }, \"In this chapter, we are going to get our hands on some of the traffic management capabilities of Istio.\", mdx(\"br\", null), mdx(\"br\", null), mdx(\"h2\", {\n    className: \"chapter-sub-heading\"\n  }, \"Apply default destination rules\"), mdx(\"br\", null), mdx(\"p\", null, \"Before we start playing with Istio's traffic management capabilities, we need to define the available versions of the deployed services. In Istio parlance, versions are called subsets. Subsets are defined in destination rules.\"), mdx(\"p\", null, \"Run the following in the custom yaml section to create default destination rules for the Bookinfo services:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-yaml\"\n  }, \"apiVersion: networking.istio.io/v1alpha3\\nkind: DestinationRule\\nmetadata:\\n  name: productpage\\nspec:\\n  host: productpage\\n  subsets:\\n    - name: v1\\n      labels:\\n        version: v1\\n---\\n\\napiVersion: networking.istio.io/v1alpha3\\nkind: DestinationRule\\nmetadata:\\nname: reviews\\nspec:\\nhost: reviews\\nsubsets: - name: v1\\nlabels:\\nversion: v1 - name: v2\\nlabels:\\nversion: v2 - name: v3\\nlabels:\\nversion: v3\\n\\n---\\n\\napiVersion: networking.istio.io/v1alpha3\\nkind: DestinationRule\\nmetadata:\\nname: ratings\\nspec:\\nhost: ratings\\nsubsets: - name: v1\\nlabels:\\nversion: v1 - name: v2\\nlabels:\\nversion: v2 - name: v2-mysql\\nlabels:\\nversion: v2-mysql - name: v2-mysql-vm\\nlabels:\\nversion: v2-mysql-vm\\n\\n---\\n\\napiVersion: networking.istio.io/v1alpha3\\nkind: DestinationRule\\nmetadata:\\nname: details\\nspec:\\nhost: details\\nsubsets: - name: v1\\nlabels:\\nversion: v1 - name: v2\\nlabels:\\nversion: v2\\n\\n---\\n\\n\")), mdx(\"p\", null, \"Using Meshery, navigate to the Istio management page:\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Enter \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"default\"), \" in the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Namespace\"), \" field.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Click the (+) icon on the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Apply Service Mesh Configuration\"), \" card and select \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Bookinfo subsets\"), \" from the list.\")), mdx(\"p\", null, \"This will deploy the destination rules for all the Book info services defining their subsets. Verify the destination rules created by using the command below:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sh\"\n  }, \"kubectl get destinationrules\\n\\n\\nkubectl get destinationrules -o yaml\\n\")), mdx(\"h2\", {\n    className: \"chapter-sub-heading\"\n  }, \"Configure the default route for all services to V1\"), mdx(\"br\", null), mdx(\"p\", null, \"As part of the bookinfo sample app, there are multiple versions of reviews service. When we load the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/productpage\"), \" in the browser multiple times we have seen the reviews service round robin between v1, v2 or v3. As the first exercise, let us first restrict traffic to just V1 of all the services.\"), mdx(\"p\", null, \"Using Meshery, navigate to the Istio management page:\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Enter \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"default\"), \" in the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Namespace\"), \" field.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Click the (+) icon on the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Apply Custom Configuration\"), \" card and paste the configuration below.\")), mdx(\"p\", null, \"To view the applied rule:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sh\"\n  }, \"kubectl get virtualservice\\n\")), mdx(\"p\", null, \"To take a look at a specific one:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sh\"\n  }, \"kubectl get virtualservice reviews -o yaml\\n\")), mdx(\"p\", null, mdx(\"em\", {\n    parentName: \"p\"\n  }, \"Please note:\"), \" In the place of the above command, we can either use kubectl or istioctl.\"), mdx(\"p\", null, \"Config:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-yaml\"\n  }, \"apiVersion: networking.istio.io/v1alpha3\\nkind: VirtualService\\nmetadata:\\n  name: reviews\\nspec:\\n  hosts:\\n    - reviews\\n  http:\\n    - route:\\n        - destination:\\n            host: reviews\\n            subset: v1\\n---\\n\\n\")), mdx(\"p\", null, \"Now when we reload the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/productpage\"), \" several times, we will ONLY be viewing the data from v1 of all the services, which means we will not see any ratings (any stars).\"), mdx(\"h2\", {\n    className: \"chapter-sub-heading\"\n  }, \" Content-based routing\"), mdx(\"br\", null), \"Let's replace our first rules with a new set. Enable the `ratings` service for a user `jason` by routing `productpage` traffic to `reviews` v2:\", mdx(\"p\", null, \"Using Meshery, navigate to the Istio management page:\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Enter \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"default\"), \" in the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Namespace\"), \" field.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Click the (+) icon on the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Apply Custom Configuration\"), \" card and paste the configuration below.\")), mdx(\"p\", null, \"This will update the existing virtual service definition for reviews to route all traffic for user \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"jason\"), \" to review V2.\"), mdx(\"p\", null, \"In a few, we should be able to verify the virtual service by using the command below:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sh\"\n  }, \"kubectl get virtualservice reviews -o yaml\\n\")), mdx(\"p\", null, \"Config:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-yaml\"\n  }, \"apiVersion: networking.istio.io/v1alpha3\\nkind: VirtualService\\nmetadata:\\n  name: reviews\\nspec:\\n  hosts:\\n    - reviews\\n  http:\\n    - match:\\n        - headers:\\n            end-user:\\n              exact: jason\\n      route:\\n        - destination:\\n            host: reviews\\n            subset: v2\\n    - route:\\n        - destination:\\n            host: reviews\\n            subset: v1\\n---\\n\\n\")), mdx(\"p\", null, \"Now if we login as your \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"jason\"), \", you will be able to see data from \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"reviews\"), \" v2. While if you NOT logged in or logged in as a different user, you will see data from \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"reviews\"), \" v1.\"), mdx(\"h2\", {\n    className: \"chapter-sub-heading\"\n  }, \"Canary Testing - Traffic Shifting\"), mdx(\"br\", null), mdx(\"h3\", {\n    className: \"chapter-sub-heading\"\n  }, \" Canary testing w/50% load\"), mdx(\"p\", null, \"To start canary testing, let's begin by transferring 50% of the traffic from reviews:v1 to reviews:v3 with the following command:\"), mdx(\"p\", null, \"Using Meshery, navigate to the Istio management page:\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Enter \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"default\"), \" in the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Namespace\"), \" field.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Click the (+) icon on the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Apply Custom Configuration\"), \" card and paste the configuration below.\")), mdx(\"p\", null, \"This will update the existing virtual service definition for reviews to route 50% of all traffic to review V3.\"), mdx(\"p\", null, \"In a few, we should be able to verify the virtual service by using the command below:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sh\"\n  }, \"kubectl get virtualservice reviews -o yaml\\n\")), mdx(\"p\", null, \"Config:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-yaml\"\n  }, \"apiVersion: networking.istio.io/v1alpha3\\nkind: VirtualService\\nmetadata:\\n  name: reviews\\nspec:\\n  hosts:\\n    - reviews\\n  http:\\n    - route:\\n        - destination:\\n            host: reviews\\n            subset: v1\\n          weight: 50\\n        - destination:\\n            host: reviews\\n            subset: v3\\n          weight: 50\\n---\\n\\n\")), mdx(\"p\", null, \"Now, if we reload the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/productpage\"), \" in your browser several times, you should now see red-colored star ratings approximately 50% of the time.\"), mdx(\"h3\", {\n    className: \"chapter-sub-heading\"\n  }, \" Shift 100% to v3\"), mdx(\"p\", null, \"When version v3 of the reviews microservice is considered stable, we can route 100% of the traffic to reviews:v3:\"), mdx(\"p\", null, \"Using Meshery, navigate to the Istio management page:\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Enter \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"default\"), \" in the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Namespace\"), \" field.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Click the (+) icon on the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Apply Custom Configuration\"), \" card and paste the configuration below.\")), mdx(\"p\", null, \"This will update the existing virtual service definition for reviews to route 100% of all traffic to review V3.\"), mdx(\"p\", null, \"In a few, we should be able to verify the virtual service by using the command below:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sh\"\n  }, \"kubectl get virtualservice reviews -o yaml\\n\")), mdx(\"p\", null, \"Config:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-yaml\"\n  }, \"apiVersion: networking.istio.io/v1alpha3\\nkind: VirtualService\\nmetadata:\\n  name: reviews\\nspec:\\n  hosts:\\n    - reviews\\n  http:\\n    - route:\\n        - destination:\\n            host: reviews\\n            subset: v3\\n---\\n\\n\")), mdx(\"p\", null, \"Now, if we reload the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/productpage\"), \" in your browser several times, you should now see red-colored star ratings 100% of the time.\"), mdx(\"br\", null), mdx(\"h3\", null, \"Alternative: Manual installation\"), \"Follow these steps if the above steps did not work\", mdx(\"br\", null), mdx(\"br\", null), mdx(\"h4\", {\n    className: \"chapter-alt-heading\"\n  }, \" Default destination rules\"), mdx(\"p\", null, \"Run the following command to create default destination rules for the Bookinfo services:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sh\"\n  }, \"kubectl apply -f samples/bookinfo/networking/destination-rule-all-mtls.yaml\\n\")), mdx(\"h4\", {\n    className: \"chapter-alt-heading\"\n  }, \" \", \"Route all traffic to version V1 of all services\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sh\"\n  }, \"kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml\\n\")), mdx(\"h4\", {\n    className: \"chapter-alt-heading\"\n  }, \" \", \"Route all traffic to version V2 of reviews for user Jason\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sh\"\n  }, \"kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml\\n\")), mdx(\"h4\", {\n    className: \"chapter-alt-heading\"\n  }, \" \", \"Route 50% of traffic to version V3 of reviews service\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sh\"\n  }, \"kubectl apply -f  samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml\\n\")), mdx(\"h4\", {\n    className: \"chapter-alt-heading\"\n  }, \" \", \"Route 100% of traffic to version V3 of reviews service\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sh\"\n  }, \"kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-v3.yaml\\n\"))));\n}\n;\nMDXContent.isMDXComponent = true;","frontmatter":{"chapterTitle":"Request Routing and Canary Testing","description":"Meshery is the cloud native management plane which offers lifecycle, configuration, and performance management of service meshes and their workloads."},"fields":{"slug":"learn/learning-paths/mastering-service-meshes-for-developers/introduction-to-service-meshes/istio/routing-and-canary/","course":"introduction-to-service-meshes","learnpath":"mastering-service-meshes-for-developers","chapter":"routing-and-canary"}},"course":{"nodes":[{"frontmatter":{"courseTitle":"Introduction to Service Meshes - Hands On","meshesYouLearn":[{"imagepath":{"childImageSharp":null,"extension":"svg","publicURL":"/static/731763d720780a49c2ffdfede8c28f4b/istio.svg"},"name":"Istio"},{"imagepath":{"childImageSharp":null,"extension":"svg","publicURL":"/static/b4f4020971de42f6fb2497075a67f325/linkerd.svg"},"name":"Linkerd"}]},"fields":{"slug":"learn/learning-paths/mastering-service-meshes-for-developers/introduction-to-service-meshes/"}}]},"TOC":{"nodes":[{"frontmatter":{"order":8,"chapterTitle":"Circuit Breaking"},"fields":{"section":"istio","chapter":"circuit-breaking"}},{"frontmatter":{"order":9,"chapterTitle":"Conclusion"},"fields":{"section":"istio","chapter":"conclusion"}},{"frontmatter":{"order":2,"chapterTitle":"Deploy a sample application"},"fields":{"section":"istio","chapter":"deploy-an-application"}},{"frontmatter":{"order":3,"chapterTitle":"Exposing services through Istio Ingress Gateway"},"fields":{"section":"istio","chapter":"expose-services"}},{"frontmatter":{"order":6,"chapterTitle":"Fault Injection"},"fields":{"section":"istio","chapter":"fault-injection"}},{"frontmatter":{"order":1,"chapterTitle":"Getting Started"},"fields":{"section":"istio","chapter":"getting-started"}},{"frontmatter":{"order":7,"chapterTitle":"Mutual TLS & Identity Verification"},"fields":{"section":"istio","chapter":"mutual-tls"}},{"frontmatter":{"order":4,"chapterTitle":"Observability"},"fields":{"section":"istio","chapter":"observability"}},{"frontmatter":{"order":5,"chapterTitle":"Request Routing and Canary Testing"},"fields":{"section":"istio","chapter":"routing-and-canary"}},{"frontmatter":{"order":9,"chapterTitle":"Conclusion"},"fields":{"section":"linkerd","chapter":"conclusion"}},{"frontmatter":{"order":4,"chapterTitle":"Linkerd Dashboard"},"fields":{"section":"linkerd","chapter":"dashboard"}},{"frontmatter":{"order":2,"chapterTitle":"Deploy a sample application"},"fields":{"section":"linkerd","chapter":"deploy-an-application"}},{"frontmatter":{"order":5,"chapterTitle":"Debugging (Optional)"},"fields":{"section":"linkerd","chapter":"debugging"}},{"frontmatter":{"order":3,"chapterTitle":"Exposing services through Linkerd Ingress"},"fields":{"section":"linkerd","chapter":"expose-services"}},{"frontmatter":{"order":8,"chapterTitle":"Fault Injection"},"fields":{"section":"linkerd","chapter":"fault-injection"}},{"frontmatter":{"order":1,"chapterTitle":"Getting Started"},"fields":{"section":"linkerd","chapter":"getting-started"}},{"frontmatter":{"order":6,"chapterTitle":"Observability"},"fields":{"section":"linkerd","chapter":"observability"}},{"frontmatter":{"order":7,"chapterTitle":"Traffic Splitting using SMI and Linkerd"},"fields":{"section":"linkerd","chapter":"traffic-splitting"}}]},"serviceMeshesList":{"nodes":[{"fields":{"section":"istio"}},{"fields":{"section":"istio"}},{"fields":{"section":"istio"}},{"fields":{"section":"istio"}},{"fields":{"section":"istio"}},{"fields":{"section":"istio"}},{"fields":{"section":"istio"}},{"fields":{"section":"istio"}},{"fields":{"section":"istio"}},{"fields":{"section":"linkerd"}},{"fields":{"section":"linkerd"}},{"fields":{"section":"linkerd"}},{"fields":{"section":"linkerd"}},{"fields":{"section":"linkerd"}},{"fields":{"section":"linkerd"}},{"fields":{"section":"linkerd"}},{"fields":{"section":"linkerd"}},{"fields":{"section":"linkerd"}}]}},"pageContext":{"learnpath":"mastering-service-meshes-for-developers","slug":"learn/learning-paths/mastering-service-meshes-for-developers/introduction-to-service-meshes/istio/routing-and-canary/","course":"introduction-to-service-meshes","section":"istio","chapter":"routing-and-canary","pageType":"chapter"}},"staticQueryHashes":["2449327605","4047814605"]}